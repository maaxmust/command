const express = require('express');
const axios = require('axios');
const cors = require('cors');

const app = express();
const port = process.env.PORT || 3000;

// keys (wie besprochen)
const openWeatherKey = 'c335251d781d377a5c8e9c94e3ea7c10';
const nasaKey = 'ucqtnncar4FshdBUccRh56isBbcIdAmJqpZea5VO';

app.use(cors());

/* ---------------- NUTZLOS-COMMAND ---------------- */
function generateDailyValue(username) {
  const today = new Date().toISOString().split('T')[0];
  const normalizedUsername = username.toLowerCase();
  const seed = `${normalizedUsername}-${today}`;
  let hash = 0;
  for (let i = 0; i < seed.length; i++) {
    hash = (hash << 5) - hash + seed.charCodeAt(i);
  }
  return Math.abs(hash % 100) + 1;
}

app.get('/nutzlos/:username', (req, res) => {
  const username = req.params.username;
  const value = generateDailyValue(username);
  res.send(`${username}, du bist heute zu ${value}% nutzlos ü•∏`);
});

/* ---------------- helpers ---------------- */
function normalizeCityName(city) {
  if (!city || typeof city !== 'string') return city;
  const map = { ae: '√§', oe: '√∂', ue: '√º', Ae: '√Ñ', Oe: '√ñ', Ue: '√ú', ss: '√ü' };
  let normalized = city;
  for (const [k, v] of Object.entries(map)) {
    normalized = normalized.replace(new RegExp(k, 'g'), v);
  }
  return normalized
    .trim()
    .split(' ')
    .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
    .join(' ');
}

function getRandomError(city) {
  const msgs = [
    `üõ∏ Hm‚Ä¶ Irgendwas stimmt nicht mit "${city}", vielleicht ein Tippfehler? ü§î`,
    `üôÉ Ups! Ich finde "${city}" gerade nicht ‚Äì vielleicht anders schreiben?`,
    `üòÖ Oh nein, "${city}" existiert nicht‚Ä¶ vielleicht falsch geschrieben?`,
    `ü§ñ "${city}" will mir keine Daten geben. Versuch‚Äôs nochmal.`,
    `ü§∑‚Äç‚ôÇÔ∏è "${city}" scheint nicht zu existieren. Vielleicht ein Tippfehler?`
  ];
  return msgs[Math.floor(Math.random() * msgs.length)];
}

/* ---------------- sehr vollst√§ndige Wetterbeschreibungen (DE + englische Varianten) ----------------
   Quelle: h√§ufige OpenWeatherMap description-strings + Varianten
   (Wir pr√ºfen description.toLowerCase() auf diese keywords)
*/
function getWeatherEmoji(description) {
  if (!description) return '';
  const t = description.toLowerCase();

  const map = [
    // Klar / Sonne
    { kw: ['klarer himmel', 'clear sky', 'klar', 'sonnig', 'sunny'], emoji: '‚òÄÔ∏è Sonnig' },
    // Wolken - feine Abstufungen
    { kw: ['few clouds', 'light clouds', 'leicht bew√∂lkt'], emoji: 'üå§Ô∏è Leicht bew√∂lkt' },
    { kw: ['scattered clouds', 'scattered cloud', 'vereinzelt wolken', 'wolkenfelder'], emoji: 'üå•Ô∏è Vereinzelte Wolken' },
    { kw: ['broken clouds', 'broken cloud', 'gebrochene wolken'], emoji: '‚òÅÔ∏è Stark bew√∂lkt' },
    { kw: ['overcast clouds', 'overcast', 'bedeckt', '√ºberwiegend bew√∂lkt'], emoji: '‚òÅÔ∏è Bedeckt' },

    // Regen / Schauer - fein
    { kw: ['light intensity shower rain', 'light shower rain', 'leichter schauer', 'light shower'], emoji: 'üå¶Ô∏è Leichter Schauer' },
    { kw: ['shower rain', 'shower'], emoji: 'üåßÔ∏è Schauerregen' },
    { kw: ['ragged shower rain', 'unregelm√§√üiger schauer', 'ragged shower'], emoji: 'üåßÔ∏è Unregelm√§√üiger Schauer' },
    { kw: ['light rain', 'leichter regen'], emoji: 'üå¶Ô∏è Leichter Regen' },
    { kw: ['moderate rain', 'm√§√üiger regen'], emoji: 'üåßÔ∏è M√§√üiger Regen' },
    { kw: ['heavy intensity rain', 'heavy rain', 'starker regen'], emoji: 'üåßÔ∏è Starker Regen' },
    { kw: ['very heavy rain', 'very heavy intensity rain', 'sehr starker regen'], emoji: 'üåßÔ∏è Sehr starker Regen' },
    { kw: ['extreme rain', 'extreme'], emoji: 'üåßÔ∏è Extrem starker Regen' },
    { kw: ['freezing rain', 'gefriereneder regen'], emoji: 'üå®Ô∏è Gefrierender Regen' },
    { kw: ['drizzle', 'nieselregen'], emoji: 'üå¶Ô∏è Nieselregen' },

    // Schnee
    { kw: ['light snow', 'leichter schnee'], emoji: '‚ùÑÔ∏è Leichter Schnee' },
    { kw: ['snow', 'schnee'], emoji: '‚ùÑÔ∏è Schnee' },
    { kw: ['heavy snow', 'starker schnee'], emoji: '‚ùÑÔ∏è Starker Schnee' },
    { kw: ['sleet', 'schneeregen'], emoji: 'üå®Ô∏è Schneeregen' },
    { kw: ['shower snow', 'schneeschauer'], emoji: 'üå®Ô∏è Schneeschauer' },

    // Gewitter & Blitz
    { kw: ['thunderstorm with light rain', 'gewitter mit leichtem regen'], emoji: '‚õàÔ∏è Gewitter mit leichtem Regen' },
    { kw: ['thunderstorm with rain', 'gewitter mit regen'], emoji: '‚õàÔ∏è Gewitter mit Regen' },
    { kw: ['thunderstorm with heavy rain', 'gewitter mit starkem regen'], emoji: '‚õàÔ∏è Gewitter mit starkem Regen' },
    { kw: ['light thunderstorm', 'leichtes gewitter'], emoji: '‚õàÔ∏è Leichtes Gewitter' },
    { kw: ['thunderstorm', 'gewitter'], emoji: '‚õàÔ∏è Gewitter' },
    { kw: ['heavy thunderstorm', 'starkes gewitter'], emoji: '‚õàÔ∏è Starkes Gewitter' },
    { kw: ['ragged thunderstorm', 'unregelm√§√üiges gewitter'], emoji: '‚õàÔ∏è Unregelm√§√üiges Gewitter' },

    // Nebel / Dunst
    { kw: ['mist', 'nebel', 'dunst', 'fog', 'haze'], emoji: 'üå´Ô∏è Nebel' },

    // Sand / Staub / Rauch
    { kw: ['sand', 'sand/dust', 'staub', 'dust'], emoji: 'üèúÔ∏è Sandig' },
    { kw: ['smoke', 'rauch'], emoji: 'üí® Rauchig' },
    { kw: ['volcanic ash', 'vulkanasche'], emoji: 'üåã Vulkanasche' },

    // Wind / St√ºrme
    { kw: ['squalls', 'b√∂en'], emoji: 'üå¨Ô∏è B√∂en' },
    { kw: ['wind', 'breeze', 'gust', 'windig'], emoji: 'üå¨Ô∏è Windig' },
    { kw: ['tornado'], emoji: 'üå™Ô∏è Tornado' },
    { kw: ['storm', 'sturm', 'orkan'], emoji: 'üå™Ô∏è Sturm' },

    // Sonstiges
    { kw: ['clear', 'sun'], emoji: '‚òÄÔ∏è Sonnig' },
    { kw: ['rainbow', 'regenbogen'], emoji: 'üåà Regenbogen' }
  ];

  for (const item of map) {
    for (const kw of item.kw) {
      if (t.includes(kw)) return item.emoji;
    }
  }
  return '';
}

/* ---------------- Exoplanet / NASA-Archiv Abfrage ----------------
   Wir verwenden das NASA Exoplanet Archive (IPAC) REST-API (table=exoplanets)
   Query Beispiel liefert JSON mit Feldern wie pl_eqt (equilibrium temp in K)
*/
async function queryExoplanetArchive(name) {
  try {
    // table=exoplanets, where pl_name='Name'
    const url = `https://exoplanetarchive.ipac.caltech.edu/cgi-bin/nstedAPI/nph-nstedAPI?table=exoplanets&format=json&where=pl_name='${encodeURIComponent(name)}'`;
    const resp = await axios.get(url, { timeout: 7000 });
    if (!resp.data || resp.data.length === 0) return null;
    return resp.data[0]; // first match
  } catch (e) {
    return null;
  }
}

/* ---------------- Mars (NASA InSight) ---------------- */
async function queryMarsInsight() {
  try {
    const resp = await axios.get(`https://api.nasa.gov/insight_weather/?api_key=${nasaKey}&feedtype=json&ver=1.0`, { timeout: 7000 });
    if (!resp.data || !resp.data.sol_keys || resp.data.sol_keys.length === 0) return null;
    const latest = resp.data.sol_keys[resp.data.sol_keys.length - 1];
    const solData = resp.data[latest];
    if (!solData || !solData.AT || typeof solData.AT.av !== 'number') return null;
    return Math.round(solData.AT.av); // ¬∞C already
  } catch (e) {
    return null;
  }
}

/* ---------------- weather endpoint (master) ---------------- */
app.get('/weather/:place', async (req, res) => {
  const raw = req.params.place;
  const place = normalizeCityName(raw);

  // helper to send with optional weatherPart
  function sendTemp(placeOut, tempC, emojiStr) {
    const part = emojiStr ? ` (${emojiStr})` : '';
    return res.send(`In ${placeOut} ist es aktuell ${tempC}¬∞C${part}`);
  }

  try {
    // 1) Erde - OpenWeatherMap (try)
    // if the place is clearly a solar object by name we'll treat later; otherwise check OpenWeather first
    const solarNames = new Set(['Mars','Sonne','Pluto','Venus','Jupiter','Saturn','Merkur','Uranus','Neptun','Mond','Sirius','Betelgeuse','Alpha Centauri','Milchstra√üe','Schwarzes Loch']);
    if (!solarNames.has(place)) {
      // use AbortController + timeout safe pattern
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 5000);
      try {
        const encoded = encodeURIComponent(raw);
        const ow = await axios.get(`https://api.openweathermap.org/data/2.5/weather?q=${encoded}&appid=${openWeatherKey}&units=metric&lang=de`, { signal: controller.signal });
        clearTimeout(timeout);

        const weather = ow.data;
        const tempC = Math.round(weather.main.temp);
        const desc = weather.weather?.[0]?.description || '';
        const emoji = getWeatherEmoji(desc);

        return sendTemp(place, tempC, emoji);
      } catch (err) {
        clearTimeout(timeout);
        // if OpenWeather fails due to not found (404) we fallback to next steps (exoplanet / solar bodies)
        // for other errors also try next steps (so we don't immediately error)
      }
    }

    // 2) Mars via NASA InSight
    if (place === 'Mars') {
      const marsTemp = await queryMarsInsight();
      if (marsTemp !== null) return sendTemp('Mars', marsTemp, 'üå¨Ô∏è Windig');
      // fallback: if no data from INSIGHT, show friendly error
      return res.send(getRandomError(place));
    }

    // 3) Known solar system / stars (try exoplanet archive for exoplanets/stars)
    // First try Exoplanet Archive (for exoplanets / star names) - query with raw string as provided
    const exo = await queryExoplanetArchive(raw);
    if (exo) {
      // pl_eqt is equilibrium temperature in K in many tables (may be null)
      // try several common fields
      const maybeFields = ['pl_eqt', 'pl_orbeccen', 'pl_orbeccen']; // pl_eqt is main
      if (typeof exo.pl_eqt === 'number') {
        const tempC = Math.round(exo.pl_eqt - 273.15);
        // Use a neutral cosmic emoji
        return sendTemp(exo.pl_name || place, tempC, 'üåå');
      }
      // If exoplanet exists but no temp, still return a friendly message
      // but per your request, we should keep same representation only when data exists
      // so if no pl_eqt, we continue to check built-in solar table below
    }

    // 4) Built-in planetary/stars fallback table (only if we have known data)
    const builtin = {
    'Sonne': { temp: 5505, emoji: '‚òÄÔ∏è Strahlend' },
    'Merkur': { temp: 167, emoji: 'üî• Gl√ºhend' },
    'Venus': { temp: 464, emoji: 'üî• Hitzeschock' },
    'Erde': { temp: 15, emoji: 'üåç Ausgeglichen' },
    'Mond': { temp: -53, emoji: 'üåï Mondklar' },
    'Mars': { temp: -63, emoji: 'üå¨Ô∏è Staubig' },
    'Jupiter': { temp: -145, emoji: 'üí® Sturmreich' },
    'Saturn': { temp: -178, emoji: 'üí® Windig' },
    'Uranus': { temp: -224, emoji: '‚ùÑÔ∏è Eisig' },
    'Neptun': { temp: -214, emoji: 'üåä Frostig' },
    'Pluto': { temp: -229, emoji: 'üßä Tiefgefroren' },
    'SchwarzesLoch': { temp: 0, emoji: 'üï≥Ô∏è Unendlich dunkel' },
    'Sirius': { temp: 9940, emoji: 'üåü Glei√üend hell' },
    'Betelgeuse': { temp: 3500, emoji: 'üåü Gl√ºhend rot' },
    'Alpha Centauri': { temp: 5790, emoji: '‚ú® Sonnengleich' },
    'Milchstra√üe': { temp: -270, emoji: 'üåå Kosmisch kalt' },
    'Andromeda': { temp: -271, emoji: 'üåå Fern und frostig' },
    'Exoplanet Kepler-452b': { temp: 265, emoji: 'ü™ê Mild' },
    'Proxima Centauri b': { temp: -39, emoji: 'üå´Ô∏è Kalt und fern' }
    };

    if (builtin[place]) {
      const obj = builtin[place];
      return sendTemp(place, obj.temp, obj.emoji);
    }

    // 5) If we got here and nothing matched, final fallback: try OpenWeather with raw again but without normalization
    try {
      const encoded2 = encodeURIComponent(raw);
      const resp2 = await axios.get(`https://api.openweathermap.org/data/2.5/weather?q=${encoded2}&appid=${openWeatherKey}&units=metric&lang=de`, { timeout: 5000 });
      const tempC = Math.round(resp2.data.main.temp);
      const desc = resp2.data.weather?.[0]?.description || '';
      const emoji = getWeatherEmoji(desc);
      return sendTemp(raw, tempC, emoji);
    } catch (e) {
      // nothing found: friendly error
      return res.send(getRandomError(place));
    }

  } catch (err) {
    return res.send(getRandomError(place));
  }
});

/* ---------------- root ---------------- */
app.get('/', (req, res) => {
  res.send('‚úÖ API l√§uft! Verwende /weather/STADT oder /weather/PLANET oder /weather/ExoplanetName');
});

/* ---------------- start ---------------- */
app.listen(port, () => console.log(`üöÄ Server l√§uft auf Port ${port}`));


